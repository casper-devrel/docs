<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-operators/maintenance/archiving-and-restoring">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Archive and Restore a DB | Casper</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.casper.network/docs/operators/maintenance/archiving-and-restoring/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Archive and Restore a DB | Casper"><meta data-rh="true" name="description" content="This documentation describes processes for the compression and decompression of a Casper node database and streaming from a backup location."><meta data-rh="true" property="og:description" content="This documentation describes processes for the compression and decompression of a Casper node database and streaming from a backup location."><link data-rh="true" rel="icon" href="/docs/icon/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.casper.network/docs/operators/maintenance/archiving-and-restoring/"><link data-rh="true" rel="alternate" href="https://docs.casper.network/docs/operators/maintenance/archiving-and-restoring/" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.casper.network/docs/operators/maintenance/archiving-and-restoring/" hreflang="x-default"><script src="/js/loadtags.js" async type="module"></script><link rel="stylesheet" href="/docs/assets/css/styles.51d7a6cc.css">
<link rel="preload" href="/docs/assets/js/runtime~main.99acb2fc.js" as="script">
<link rel="preload" href="/docs/assets/js/main.6862a68c.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navBarWrapper_phG8"><div class="containerSite fullNavBarHeight__XV6"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle documentation navigation bar" aria-expanded="false" class="navbar__toggle clean-btn navbarMobileTitle_ZINc"><div class="navbarMobileTitle_container_Qxup">Documentation<svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.9822 2.57144H9.97778C9.90948 2.57144 9.84519 2.60492 9.80501 2.65983L6.0001 7.90448L2.19519 2.65983C2.15501 2.60492 2.09072 2.57144 2.02242 2.57144H1.01796C0.930903 2.57144 0.880011 2.67055 0.930903 2.74153L5.65322 9.2518C5.82465 9.48751 6.17555 9.48751 6.34564 9.2518L11.068 2.74153C11.1202 2.67055 11.0693 2.57144 10.9822 2.57144Z" fill="#F4F4F4"></path></svg></div></button><a class="navbar__item navbar__link" href="/docs/concepts/">Concepts</a><a class="navbar__item navbar__link" href="/docs/developers/">Developers</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/operators/">Operators</a><a class="navbar__item navbar__link" href="/docs/users/">Users</a><a class="navbar__item navbar__link" href="/docs/resources/">Resources</a><a href="https://support.casperlabs.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Support<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://discord.com/invite/casperblockchain" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Chat<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/docs/operators/maintenance/archiving-and-restoring/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li></ul></div><a href="https://github.com/casper-network/docs/blob/dev/README.md" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div></div></div></nav><div role="presentation" class="navbar-sidebar__backdrop"></div><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_W2AM"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage_qMb8"><aside class="theme-doc-sidebar-container docSidebarContainer_NXUq" style="--dynamicNavBarSiteHeight:0px"><div class="sidebarViewport_P4AQ"><div class="sidebar_mhZE"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_Y1UP"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/operators/">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/operators/setup/">Node Setup</a><button aria-label="Toggle the collapsible sidebar category &#x27;Node Setup&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/operators/becoming-a-validator/">Validators</a><button aria-label="Toggle the collapsible sidebar category &#x27;Validators&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/operators/setup-network/">Private Networks</a><button aria-label="Toggle the collapsible sidebar category &#x27;Private Networks&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/operators/maintenance/">Maintenance</a><button aria-label="Toggle the collapsible sidebar category &#x27;Maintenance&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/operators/maintenance/archiving-and-restoring/">Archive and Restore a DB</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/operators/maintenance/moving-node/">Move a Node</a></li></ul></li></ul></nav><button type="button" tabindex="0" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_JQG6"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_Iseg"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_RiV8"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Alpn" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/docs/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/operators/"><span itemprop="name">Operators</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/operators/maintenance/"><span itemprop="name">Maintenance</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Archive and Restore a DB</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Archiving and Restoring a Database</h1><p>This documentation describes processes for the compression and decompression of a Casper node database and streaming from a backup location.</p><p><a href="http://facebook.github.io/zstd/" target="_blank" rel="noopener noreferrer">Zstandard</a> is the best method for compression speed and space for the current LMDB-based database system that the <code>casper-node</code> uses. </p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>The values presented in this document assume that the <code>trie-compact</code> tool was run on a Mainnet database for compression. Contact the <a href="https://support.casperlabs.io/hc/en-gb" target="_blank" rel="noopener noreferrer">support team</a> if you have questions.</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="zstandard-limitations">Zstandard Limitations<a href="#zstandard-limitations" class="hash-link" aria-label="Direct link to Zstandard Limitations" title="Direct link to Zstandard Limitations">​</a></h2><p>The current DB implementation uses sparse files, which can be partially empty, thus not being processed efficiently. You can use <code>tar</code> as a pre-filter for stripping sparse data, as shown <a href="#compression">here</a>, thus eliminating the need to read the full DB size and improving processing.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="zstandard-installation">Zstandard Installation<a href="#zstandard-installation" class="hash-link" aria-label="Direct link to Zstandard Installation" title="Direct link to Zstandard Installation">​</a></h2><p>To install Zstandard, run the following command:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">apt</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">install</span><span class="token plain"> zstd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note that Zstandard version 1.4.4 is distributed with Ubuntu 20.04, while version 1.3.3 is distributed with Ubuntu 18.04. Later versions have more documentation. </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="initial-warnings">Initial Warnings<a href="#initial-warnings" class="hash-link" aria-label="Direct link to Initial Warnings" title="Direct link to Initial Warnings">​</a></h2><p>You need to stop the <code>casper-node-launcher</code> process of the node (and, therefore, the <code>casper-node</code> process using the DB) before any compression or decompression into a location. Otherwise, strange things can and will occur.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="compression">Compression<a href="#compression" class="hash-link" aria-label="Direct link to Compression" title="Direct link to Compression">​</a></h2><p>Run the following basic <code>tar</code> command from the DB directory. For Mainnet, the directory would be <code>/var/lib/casper/casper-node/casper</code>, and for Testnet it would be <code>/var/lib/casper/casper-node/casper-test</code>.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">tar</span><span class="token plain"> -cv --sparse </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>On some systems, you may get better performance if you specify the block number as an argument:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">tar</span><span class="token plain"> -b </span><span class="token number">4096</span><span class="token plain"> -cv --sparse </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You can then stream the result into <code>zstd</code>. The sections below discuss the <a href="#compression-level">level</a>, <a href="#thread-count">thread count</a>, and <a href="#long-distance-matching">long</a> arguments.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">tar</span><span class="token plain"> -b </span><span class="token number">4096</span><span class="token plain"> -cv --sparse </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">.</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> zstd -</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">level</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> -cv -T</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">thread count</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> --long</span><span class="token operator">=</span><span class="token number">31</span><span class="token plain"> </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">path_to</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">/file.tar.zst</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="compression-level">Compression level<a href="#compression-level" class="hash-link" aria-label="Direct link to Compression level" title="Direct link to Compression level">​</a></h3><p>The <code>-[level]</code> argument is the compression level from 1 to 19 (and 20-22 with expansion). In testing, we found 15 to be the sweet spot in compression time vs. size. We recommend lower compression if you plan to transfer the archive only once. If you are creating an archive to be downloaded by many, then the extra time for higher compression may be helpful.</p><p>Here are some examples of a Mainnet DB compression at block 741160:</p><table><thead><tr><th>Level</th><th>Time (min:sec)</th><th>Size</th></tr></thead><tbody><tr><td>12</td><td>29:20</td><td>15.8 GB</td></tr><tr><td>15</td><td>46:15</td><td>13.0 GB</td></tr><tr><td>17</td><td>87:42</td><td>13.0 GB</td></tr><tr><td>19</td><td>197:08</td><td>12.9 GB</td></tr></tbody></table><p>For local backups, using 1-5 is a great compression speed-to-size trade-off.  </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="thread-count">Thread count<a href="#thread-count" class="hash-link" aria-label="Direct link to Thread count" title="Direct link to Thread count">​</a></h3><p>The <code>-T[thread count]</code> is the number of threads that <code>zstd</code> should use for compression. If running a script or command on varying machines, use <code>T0</code> to allow <code>zstd</code> to detect the number of cores and run with the same number of threads as the detected cores. A speed-up can be obtained for machines with multiple threads per core by configuring a thread count near the number of threads. It is advisable to stay within the number of CPU threads. The recommendations in this article will use <code>-T0</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="long-distance-matching">Long-distance matching<a href="#long-distance-matching" class="hash-link" aria-label="Direct link to Long-distance matching" title="Direct link to Long-distance matching">​</a></h3><p>The <code>--long=31</code> argument is where we see the most space gained by the algorithm because it controls the size of the matching window in powers of 2 (2**31 is 2 GB). The downside is that it requires 2.0 GB memory during compression and decompression as it looks and rebuilds ahead. The default is 27 or 128 MB.</p><p>At compression 19, we see a 30 GB file using the default 128 MB look ahead, and a 13 GB file using 2 GB look ahead. Since all validators should have 16-32 GB of memory, we keep this at <code>--long=31</code>.</p><p>An important note is that decompression requires a compatible argument. Trying with a different long-distance matching value will result in an error. However, it will also return the necessary value to provide.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="summary-of-commands">Summary of commands<a href="#summary-of-commands" class="hash-link" aria-label="Direct link to Summary of commands" title="Direct link to Summary of commands">​</a></h3><p>The general command for compression is:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">tar</span><span class="token plain"> -b </span><span class="token number">4096</span><span class="token plain"> -cv --sparse </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">.</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> zstd -15 -cv -T0 --long</span><span class="token operator">=</span><span class="token number">31</span><span class="token plain"> </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">path_to</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">/file.tar.zst</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>For local backups, use a lower compression level:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">tar</span><span class="token plain"> -b </span><span class="token number">4096</span><span class="token plain"> -cv --sparse </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">.</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> zstd -5 -cv -T0 --long</span><span class="token operator">=</span><span class="token number">31</span><span class="token plain"> </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">path_to</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">/file.tar.zst</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="decompression">Decompression<a href="#decompression" class="hash-link" aria-label="Direct link to Decompression" title="Direct link to Decompression">​</a></h2><p><code>zstd -d</code> is the command for decompression; however, the same <code>--long</code> value used for compression must be specified. For all <code>casper-node</code> DB-related decompression, you will likely use this command:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">zstd -cd --long</span><span class="token operator">=</span><span class="token number">31</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">.tar.zst file</span><span class="token operator">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If <code>--long=31</code> is omitted, you might see an error such as this, which also gives you the solution:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">./casper.tar.zst </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token plain"> Decoding error </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">36</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token plain"> Frame requires too much memory </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> decoding </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">./casper.tar.zst </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token plain"> Window size larger than maximum </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token plain"> </span><span class="token number">2147483648</span><span class="token plain"> </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">134217728</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">./casper.tar.zst </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token plain"> Use --long</span><span class="token operator">=</span><span class="token number">31</span><span class="token plain"> or --memory</span><span class="token operator">=</span><span class="token plain">2048MB</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You can then use the <code>zstd</code> result to populate a <code>tar -xv</code> command. Also, create the decompressed files using <code>sudo -u casper</code>, because the files will be used by the <code>casper-node</code>. Run the following command inside an empty DB location:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">zstd -cd --long</span><span class="token operator">=</span><span class="token number">31</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">.tar.zst file</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">sudo</span><span class="token plain"> -u casper </span><span class="token function" style="color:rgb(80, 250, 123)">tar</span><span class="token plain"> -xv</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To fix ownership, use this command:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">sudo</span><span class="token plain"> /etc/casper/node_util.py fix_permissions</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="streamed-decompression">Streamed Decompression<a href="#streamed-decompression" class="hash-link" aria-label="Direct link to Streamed Decompression" title="Direct link to Streamed Decompression">​</a></h2><p>If a <code>.tar.zst</code> archive is hosted on a website and you will not need the file after decompressing, you can stream it into the process using <code>curl</code>, which can output to stdout with <code>--output</code> and stream binary to your terminal.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> -s --output - </span><span class="token operator">&lt;</span><span class="token plain">URL </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> tar.zstd file</span><span class="token operator">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If you use the output along with the previous process, you can decompress the files from <code>curl</code> directly into a local directory:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> -s --output - </span><span class="token operator">&lt;</span><span class="token plain">tar.zst URL</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> zstd -d --long</span><span class="token operator">=</span><span class="token number">31</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">sudo</span><span class="token plain"> -u casper </span><span class="token function" style="color:rgb(80, 250, 123)">tar</span><span class="token plain"> -xv</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="starting-a-new-node-with-a-decompressed-db">Starting a New Node with a Decompressed DB<a href="#starting-a-new-node-with-a-decompressed-db" class="hash-link" aria-label="Direct link to Starting a New Node with a Decompressed DB" title="Direct link to Starting a New Node with a Decompressed DB">​</a></h2><p>If you are starting a node with a decompressed DB, you must tell the node to run at the protocol version of the tip of your DB. You can do this most efficiently with the <code>node_util.py</code> script included in the <code>casper-node-launcher</code> installation.</p><p>For example, if you are using a DB archive from node version 1.4.5, you would run this command:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">sudo</span><span class="token plain"> /etc/casper/node_util.py force_run_version 1_4_5</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/casper-network/docs/tree/dev/source/docs/casper/operators/maintenance/archiving-and-restoring.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2023-07-14T20:20:49.000Z">Jul 14, 2023</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/operators/maintenance/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Node Maintenance</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/operators/maintenance/moving-node/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Move a Node</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#zstandard-limitations" class="table-of-contents__link toc-highlight">Zstandard Limitations</a></li><li><a href="#zstandard-installation" class="table-of-contents__link toc-highlight">Zstandard Installation</a></li><li><a href="#initial-warnings" class="table-of-contents__link toc-highlight">Initial Warnings</a></li><li><a href="#compression" class="table-of-contents__link toc-highlight">Compression</a><ul><li><a href="#compression-level" class="table-of-contents__link toc-highlight">Compression level</a></li><li><a href="#thread-count" class="table-of-contents__link toc-highlight">Thread count</a></li><li><a href="#long-distance-matching" class="table-of-contents__link toc-highlight">Long-distance matching</a></li><li><a href="#summary-of-commands" class="table-of-contents__link toc-highlight">Summary of commands</a></li></ul></li><li><a href="#decompression" class="table-of-contents__link toc-highlight">Decompression</a></li><li><a href="#streamed-decompression" class="table-of-contents__link toc-highlight">Streamed Decompression</a></li><li><a href="#starting-a-new-node-with-a-decompressed-db" class="table-of-contents__link toc-highlight">Starting a New Node with a Decompressed DB</a></li></ul></div></div></div></div></main></div></div><div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright"><div class="footer-inner-container">
    <div class="footer-top">
        <ul class="items">
            <li><a href="https://arxiv.org/pdf/2101.02159.pdf" target="_blank" rel="noopener">White Paper</a></li>
            <li>
                <a href="https://docs.casper.network" target="_blank" rel="noopener">
                    Docs
                </a>
            </li>
            <li><a href="https://devxdao.com/" target="_blank" rel="noopener">Grant Program</a></li>
            <li><a href="https://casper.network/network/casper-association" target="_blank" rel="noopener">Casper Association</a></li>
        </ul>
    </div>
    <div class="footer-bottom">
        <ul class="items left">
            <li>
                <a href="https://casper.network/en/network" target="_blank" rel="noopener">
                    <img class="footer-logo" src="/icon/Casper_Wordmark_White_RGB.png" alt="Casper Logo">
                </a>
            </li>
            <li>© 2023 Casper Association</li>
        </ul>
        <ul class="items right">
            <li class="trademark">
                <a href="https://casper.network/network/trademark-policy" target="_blank" rel="noopener">Trademark Policy and Guidelines</a>
            </li>
        </ul>
    </div>
</div>
</div></div></div></footer></div></div>
<script src="/docs/assets/js/runtime~main.99acb2fc.js"></script>
<script src="/docs/assets/js/main.6862a68c.js"></script>
</body>
</html>